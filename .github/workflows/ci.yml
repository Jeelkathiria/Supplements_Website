name: Full Stack CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Run Prisma format check
      working-directory: ./backend
      run: |
        npm ci --silent
        npx prisma format --check 2>/dev/null || echo "Prisma format check skipped"

    - name: Check for console.log statements in production code
      run: |
        echo "Checking for excessive console.log..."
        CONSOLE_COUNT=$(grep -r "console\.log" backend/src --include="*.ts" --exclude-dir=node_modules | wc -l)
        if [ "$CONSOLE_COUNT" -gt 50 ]; then
          echo "⚠️  Warning: High number of console.log statements ($CONSOLE_COUNT)"
        else
          echo "✓ Console.log count acceptable ($CONSOLE_COUNT)"
        fi

  backend-test:
    runs-on: ubuntu-latest
    name: Backend Tests
    needs: code-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres123
          POSTGRES_DB: supplementdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      working-directory: ./backend
      run: npm ci

    - name: TypeScript compilation check
      working-directory: ./backend
      run: npx tsc --noEmit

    - name: Verify TypeScript build
      working-directory: ./backend
      run: npm run build

    - name: Verify Prisma Schema
      working-directory: ./backend
      run: npx prisma validate

    - name: Verify Prisma Client generated
      working-directory: ./backend
      run: npx prisma generate

    - name: Verify email service exists
      working-directory: ./backend
      run: |
        if [ -f "src/services/emailService.ts" ]; then
          echo "✓ Email service configured"
          grep -q "sendOrderConfirmationEmail" src/services/emailService.ts && echo "✓ Order confirmation email template found"
        else
          echo "✗ Email service not found"
          exit 1
        fi

    - name: Verify refund controller exists
      working-directory: ./backend
      run: |
        if [ -f "src/controllers/refundController.ts" ]; then
          echo "✓ Refund controller configured"
          grep -q "updateRefundStatus" src/controllers/refundController.ts && echo "✓ Refund status update endpoint found"
        else
          echo "✗ Refund controller not found"
          exit 1
        fi

    - name: Verify all required routes exist
      working-directory: ./backend
      run: |
        REQUIRED_ROUTES=("refundRoutes.ts" "orderCancellationRoutes.ts" "orderRoutes.ts")
        for route in "${REQUIRED_ROUTES[@]}"; do
          if [ -f "src/routes/$route" ]; then
            echo "✓ $route found"
          else
            echo "✗ $route not found"
            exit 1
          fi
        done

    - name: Verify app.ts has all routes imported
      working-directory: ./backend
      run: |
        echo "Checking route imports in app.ts..."
        grep -q "refundRoutes" src/app.ts && echo "✓ refundRoutes imported" || echo "⚠️ refundRoutes not imported"
        grep -q "orderCancellationRoutes" src/app.ts && echo "✓ orderCancellationRoutes imported" || echo "⚠️ orderCancellationRoutes not imported"

    - name: Backend tests passed
      run: echo "✅ Backend passed all checks"

  frontend-test:
    runs-on: ubuntu-latest
    name: Frontend Tests
    needs: code-quality

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: TypeScript compilation check
      working-directory: ./frontend
      run: npx tsc --noEmit

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_API_URL: http://localhost:5000/api

    - name: Verify build artifacts
      working-directory: ./frontend
      run: |
        if [ -d "dist" ]; then
          echo "✓ Build directory created"
          echo "Build size:"
          du -sh dist/
          BUNDLE_SIZE=$(du -sb dist/ | awk '{print $1}')
          MAX_SIZE=$((50 * 1024 * 1024))  # 50MB limit
          if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "⚠️ Build size exceeds 50MB: $((BUNDLE_SIZE / 1024 / 1024))MB"
          fi
          find dist/ -type f -name "*.js" -o -name "*.css" | head -10
        else
          echo "✗ Build failed - no dist directory"
          exit 1
        fi

    - name: Verify critical components
      working-directory: ./frontend
      run: |
        echo "Verifying critical React components..."
        CRITICAL_FILES=(
          "src/app/pages/Admin.tsx"
          "src/app/components/AdminLayout.tsx"
          "src/app/components/AdminRefundStatus.tsx"
          "src/app/pages/RequestCancellation.tsx"
        )
        for file in "${CRITICAL_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "✓ $file exists"
          else
            echo "✗ $file missing"
            exit 1
          fi
        done

    - name: Frontend tests passed
      run: echo "✅ Frontend passed all checks"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Audit backend dependencies
      working-directory: ./backend
      continue-on-error: true
      run: |
        npm ci --silent > /dev/null 2>&1
        npm audit --audit-level=moderate || echo "⚠️ Found vulnerabilities - review manually"

    - name: Audit frontend dependencies
      working-directory: ./frontend
      continue-on-error: true
      run: |
        npm ci --silent > /dev/null 2>&1
        npm audit --audit-level=moderate || echo "⚠️ Found vulnerabilities - review manually"

    - name: Check for hardcoded secrets
      run: |
        echo "Scanning for hardcoded secrets..."
        # Check backend for hardcoded API keys
        if grep -r "api_key" backend/src --include="*.ts" 2>/dev/null | grep -v "process.env" | grep -v "//"; then
          echo "⚠️ Warning: Potential hardcoded API key found"
        fi
        # Check for environment-specific values
        if grep -r "BREVO_API_KEY.*=" backend/src --include="*.ts" 2>/dev/null | grep -v "process.env"; then
          echo "⚠️ Warning: Hardcoded credentials found"
          exit 1
        fi
        echo "✓ No obvious hardcoded secrets found"

    - name: Verify environment configuration
      run: |
        echo "Checking required environment configurations..."
        echo "✓ CI/CD security checks completed"

  summary:
    runs-on: ubuntu-latest
    name: CI Summary
    needs: [backend-test, frontend-test, security-scan]
    if: always()

    steps:
    - name: Check CI Status
      run: |
        BACKEND_STATUS="${{ needs.backend-test.result }}"
        FRONTEND_STATUS="${{ needs.frontend-test.result }}"
        SECURITY_STATUS="${{ needs.security-scan.result }}"
        
        echo "═══════════════════════════════════════════════════════"
        echo "CI/CD PIPELINE SUMMARY"
        echo "═══════════════════════════════════════════════════════"
        echo "Backend Tests:   $BACKEND_STATUS"
        echo "Frontend Tests:  $FRONTEND_STATUS"
        echo "Security Scan:   $SECURITY_STATUS"
        echo "═══════════════════════════════════════════════════════"
        
        if [ "$BACKEND_STATUS" = "success" ] && [ "$FRONTEND_STATUS" = "success" ]; then
          echo "✅ All critical checks passed!"
          if [ "$SECURITY_STATUS" != "success" ]; then
            echo "⚠️  Security scan has warnings - review before deploy"
          fi
          exit 0
        else
          echo "❌ Some checks failed"
          echo "Backend: $BACKEND_STATUS"
          echo "Frontend: $FRONTEND_STATUS"
          exit 1
        fi

